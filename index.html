<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyword Report Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #111827;
        }
        
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            max-width: 1024px;
            margin: 0 auto;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
        }
        
        .header-icon {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            fill: #2563eb;
        }
        
        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .container {
            max-width: 1024px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }
        
        .upload-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            text-align: center;
        }
        
        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            fill: #9ca3af;
        }
        
        .upload-title {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .upload-description {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }
        
        .upload-button {
            background: #2563eb;
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }
        
        .upload-button:hover {
            background: #1d4ed8;
        }
        
        .file-input {
            display: none;
        }
        
        .error-message {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            color: #dc2626;
            font-size: 0.875rem;
        }
        
        .loading-message {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            color: #1d4ed8;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #2563eb;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .report-section {
            display: none;
        }
        
        .report-header {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .report-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .report-date {
            color: #6b7280;
        }
        
        .report-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-green {
            background: #059669;
            color: white;
        }
        
        .btn-green:hover {
            background: #047857;
        }
        
        .btn-gray {
            background: #4b5563;
            color: white;
        }
        
        .btn-gray:hover {
            background: #374151;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .metric-label {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }
        
        .competition-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        .competition-item {
            text-align: center;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .competition-count {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .competition-high { color: #dc2626; }
        .competition-medium { color: #d97706; }
        .competition-low { color: #059669; }
        
        .table-container {
            overflow-x: auto;
        }
        
        .keyword-table {
            width: 100%;
            font-size: 0.875rem;
            border-collapse: collapse;
        }
        
        .keyword-table th {
            padding: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
            text-align: left;
        }
        
        .keyword-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .keyword-table tr:hover {
            background: #f9fafb;
        }
        
        .competition-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .competition-badge-high {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .competition-badge-medium {
            background: #fef3c7;
            color: #d97706;
        }
        
        .competition-badge-low {
            background: #d1fae5;
            color: #059669;
        }
        
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .text-green { color: #059669; font-weight: 500; }
        
        .hidden { display: none; }
        
        @media (max-width: 768px) {
            .report-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <svg class="header-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="10,9 9,9 8,9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h1 class="header-title">Keyword Report Generator</h1>
        </div>
    </div>

    <div class="container">
        <!-- Upload Section -->
        <div id="uploadSection" class="upload-section">
            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="17,8 12,3 7,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h2 class="upload-title">Upload Your CSV File</h2>
            <p class="upload-description">Generate a clean, professional keyword performance report</p>
            
            <label for="fileInput" class="upload-button">
                Choose File
            </label>
            <input type="file" id="fileInput" class="file-input" accept=".csv">
            
            <div id="errorMessage" class="error-message hidden"></div>
            <div id="loadingMessage" class="loading-message hidden">
                <div class="spinner"></div>
                Processing...
            </div>
        </div>

        <!-- Report Section -->
        <div id="reportSection" class="report-section">
            <!-- Report Header -->
            <div class="report-header">
                <div>
                    <h2 class="report-title">Keyword Performance Report</h2>
                    <p class="report-date" id="reportDate"></p>
                </div>
                <div class="report-actions">
                    <button class="btn btn-green" onclick="downloadPDF()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7,10 12,15 17,10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Download PDF
                    </button>
                    <button class="btn btn-gray" onclick="newReport()">New Report</button>
                </div>
            </div>

            <!-- Key Metrics -->
            <div id="metricsGrid" class="metrics-grid"></div>

            <!-- Competition Distribution -->
            <div class="section">
                <h3 class="section-title">Competition Distribution</h3>
                <div id="competitionGrid" class="competition-grid"></div>
            </div>

            <!-- Top Keywords -->
            <div class="section">
                <h3 class="section-title">Top 10 Keywords</h3>
                <div class="table-container">
                    <table class="keyword-table" id="topKeywordsTable">
                        <thead>
                            <tr>
                                <th>Keyword</th>
                                <th class="text-right">Monthly Searches</th>
                                <th class="text-center">Competition</th>
                                <th class="text-right">Top of Page Bid</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Growing Keywords -->
            <div class="section hidden" id="growingSection">
                <h3 class="section-title">Growing Keywords</h3>
                <div class="table-container">
                    <table class="keyword-table" id="growingKeywordsTable">
                        <thead>
                            <tr>
                                <th>Keyword</th>
                                <th class="text-right">Monthly Searches</th>
                                <th class="text-center">Competition</th>
                                <th class="text-right">YoY Growth</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Opportunities -->
            <div class="section hidden" id="opportunitiesSection">
                <h3 class="section-title">High Opportunity Keywords</h3>
                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">Keywords with good search volume and low/medium competition</p>
                <div class="table-container">
                    <table class="keyword-table" id="opportunitiesTable">
                        <thead>
                            <tr>
                                <th>Keyword</th>
                                <th class="text-right">Monthly Searches</th>
                                <th class="text-center">Competition</th>
                                <th class="text-right">Top of Page Bid</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let csvData = null;
        let report = null;

        // Utility functions
        function parseNumeric(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                // Handle special characters and formats
                if (value === '∞' || value === 'Infinity' || value === '') return 0;
                const cleaned = value.replace(/[,$%∞]/g, '');
                const num = parseFloat(cleaned);
                return isNaN(num) ? 0 : num;
            }
            return 0;
        }

        function parsePercentage(value) {
            if (typeof value === 'string') {
                if (value === '∞' || value === 'Infinity') return 0;
                if (value.includes('%')) {
                    const cleaned = value.replace('%', '');
                    return parseFloat(cleaned);
                }
            }
            return parseNumeric(value);
        }

        function calculateAverageBid(lowRange, highRange) {
            const low = parseNumeric(lowRange);
            const high = parseNumeric(highRange);
            if (low === 0 && high === 0) return 0;
            return (low + high) / 2;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showLoading() {
            document.getElementById('loadingMessage').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingMessage').classList.add('hidden');
        }

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type === 'text/csv') {
                processCSV(file);
            } else {
                showError('Please upload a valid CSV file.');
            }
        });

        function processCSV(file) {
            showLoading();
            hideError();

            Papa.parse(file, {
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    try {
                        // Find the header row (contains "Keyword")
                        let headerRowIndex = -1;
                        for (let i = 0; i < results.data.length; i++) {
                            if (results.data[i][0] === 'Keyword') {
                                headerRowIndex = i;
                                break;
                            }
                        }

                        if (headerRowIndex === -1) {
                            throw new Error('Could not find keyword data in CSV');
                        }

                        // Extract headers and data
                        const headers = results.data[headerRowIndex];
                        const dataRows = results.data.slice(headerRowIndex + 1);

                        // Convert to objects
                        const data = dataRows
                            .map(row => {
                                const obj = {};
                                headers.forEach((header, index) => {
                                    obj[header] = row[index];
                                });
                                return obj;
                            })
                            .filter(row => row.Keyword && row.Keyword.trim() !== '' && row.Keyword !== 'Keyword');

                        csvData = data;
                        generateReport(data);
                    } catch (err) {
                        showError('Error processing CSV file: ' + err.message);
                        console.error('CSV processing error:', err);
                    }
                    hideLoading();
                },
                error: function(error) {
                    showError('Failed to parse CSV file: ' + error.message);
                    hideLoading();
                }
            });
        }

        function generateReport(data) {
            console.log('Processing data:', data); // Debug log

            const totalKeywords = data.length;
            const totalSearchVolume = _.sumBy(data, row => parseNumeric(row['Avg. monthly searches']));
            const avgMonthlySearches = Math.round(totalSearchVolume / totalKeywords);

            const competitionDistribution = _.countBy(data, 'Competition');
            
            // Calculate average bid using the average of low and high range
            const avgBid = _.meanBy(data, row => calculateAverageBid(
                row['Top of page bid (low range)'], 
                row['Top of page bid (high range)']
            ));

            const topKeywords = _.orderBy(data, 
                row => parseNumeric(row['Avg. monthly searches']), 
                'desc'
            ).slice(0, 10);

            const growingKeywords = data.filter(row => {
                const yoyChange = parsePercentage(row['YoY change']);
                return yoyChange > 0;
            }).slice(0, 5);

            const opportunities = data.filter(row => {
                const volume = parseNumeric(row['Avg. monthly searches']);
                const competition = row['Competition'];
                return volume >= 50 && (competition === 'Low' || competition === 'Medium');
            }).slice(0, 5);

            report = {
                totalKeywords,
                totalSearchVolume,
                avgMonthlySearches,
                competitionDistribution,
                avgBid: isNaN(avgBid) ? 0 : avgBid.toFixed(2),
                topKeywords,
                growingKeywords,
                opportunities,
                generatedDate: new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                })
            };

            console.log('Generated report:', report); // Debug log
            displayReport();
        }

        function displayReport() {
            // Show report section
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('reportSection').style.display = 'block';

            // Set report date
            document.getElementById('reportDate').textContent = `Generated on ${report.generatedDate}`;

            // Display metrics
            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${report.totalKeywords}</div>
                    <div class="metric-label">Total Keywords</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${report.totalSearchVolume.toLocaleString()}</div>
                    <div class="metric-label">Monthly Searches</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${report.avgMonthlySearches.toLocaleString()}</div>
                    <div class="metric-label">Avg per Keyword</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">$${report.avgBid}</div>
                    <div class="metric-label">Avg Top of Page Bid</div>
                </div>
            `;

            // Display competition distribution
            const competitionGrid = document.getElementById('competitionGrid');
            competitionGrid.innerHTML = Object.entries(report.competitionDistribution).map(([level, count]) => `
                <div class="competition-item">
                    <div class="competition-count competition-${level.toLowerCase()}">${count}</div>
                    <div>${level}</div>
                </div>
            `).join('');

            // Display top keywords
            const topKeywordsTable = document.getElementById('topKeywordsTable').querySelector('tbody');
            topKeywordsTable.innerHTML = report.topKeywords.map(keyword => `
                <tr>
                    <td style="font-weight: 500;">${keyword.Keyword}</td>
                    <td class="text-right">${parseNumeric(keyword['Avg. monthly searches']).toLocaleString()}</td>
                    <td class="text-center">
                        <span class="competition-badge competition-badge-${keyword.Competition?.toLowerCase() || 'low'}">
                            ${keyword.Competition || 'Low'}
                        </span>
                    </td>
                    <td class="text-right">$${calculateAverageBid(keyword['Top of page bid (low range)'], keyword['Top of page bid (high range)']).toFixed(2)}</td>
                </tr>
            `).join('');

            // Display growing keywords if available
            if (report.growingKeywords.length > 0) {
                document.getElementById('growingSection').classList.remove('hidden');
                const growingTable = document.getElementById('growingKeywordsTable').querySelector('tbody');
                growingTable.innerHTML = report.growingKeywords.map(keyword => `
                    <tr>
                        <td style="font-weight: 500;">${keyword.Keyword}</td>
                        <td class="text-right">${parseNumeric(keyword['Avg. monthly searches']).toLocaleString()}</td>
                        <td class="text-center">
                            <span class="competition-badge competition-badge-${keyword.Competition?.toLowerCase() || 'low'}">
                                ${keyword.Competition || 'Low'}
                            </span>
                        </td>
                        <td class="text-right text-green">+${parsePercentage(keyword['YoY change'])}%</td>
                    </tr>
                `).join('');
            }

            // Display opportunities if available
            if (report.opportunities.length > 0) {
                document.getElementById('opportunitiesSection').classList.remove('hidden');
                const opportunitiesTable = document.getElementById('opportunitiesTable').querySelector('tbody');
                opportunitiesTable.innerHTML = report.opportunities.map(keyword => `
                    <tr>
                        <td style="font-weight: 500;">${keyword.Keyword}</td>
                        <td class="text-right">${parseNumeric(keyword['Avg. monthly searches']).toLocaleString()}</td>
                        <td class="text-center">
                            <span class="competition-badge competition-badge-${keyword.Competition?.toLowerCase() || 'low'}">
                                ${keyword.Competition || 'Low'}
                            </span>
                        </td>
                        <td class="text-right">$${calculateAverageBid(keyword['Top of page bid (low range)'], keyword['Top of page bid (high range)']).toFixed(2)}</td>
                    </tr>
                `).join('');
            }
        }

        function downloadPDF() {
            const printWindow = window.open('', '_blank');
            const reportHTML = generatePDFContent();
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                    <head>
                        <title>Keyword Performance Report</title>
                        <meta charset="utf-8">
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body { 
                                font-family: 'Arial', sans-serif; 
                                line-height: 1.6; 
                                color: #333;
                                background: white;
                            }
                            .report-container { 
                                max-width: 800px; 
                                margin: 0 auto; 
                                padding: 40px;
                            }
                            .header { 
                                text-align: center; 
                                margin-bottom: 40px;
                                border-bottom: 3px solid #3B82F6;
                                padding-bottom: 20px;
                            }
                            .header h1 { 
                                color: #1F2937; 
                                font-size: 28px; 
                                margin-bottom: 8px;
                                font-weight: 700;
                            }
                            .header p { 
                                color: #6B7280; 
                                font-size: 14px;
                            }
                            .metrics-grid { 
                                display: grid; 
                                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
                                gap: 20px; 
                                margin-bottom: 30px;
                            }
                            .metric-card { 
                                background: #F8FAFC; 
                                padding: 20px; 
                                border-radius: 8px; 
                                border-left: 4px solid #3B82F6;
                                text-align: center;
                            }
                            .metric-value { 
                                font-size: 24px; 
                                font-weight: bold; 
                                color: #1F2937; 
                                margin-bottom: 4px;
                            }
                            .metric-label { 
                                font-size: 12px; 
                                color: #6B7280; 
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            }
                            .section { 
                                margin-bottom: 30px;
                            }
                            .section-title { 
                                font-size: 18px; 
                                color: #1F2937; 
                                margin-bottom: 15px;
                                font-weight: 600;
                                border-bottom: 2px solid #E5E7EB;
                                padding-bottom: 8px;
                            }
                            .keyword-table { 
                                width: 100%; 
                                border-collapse: collapse; 
                                font-size: 12px;
                            }
                            .keyword-table th { 
                                background: #F3F4F6; 
                                padding: 10px 8px; 
                                text-align: left; 
                                font-weight: 600;
                                border-bottom: 2px solid #D1D5DB;
                            }
                            .keyword-table td { 
                                padding: 8px; 
                                border-bottom: 1px solid #E5E7EB;
                            }
                            .keyword-table tr:hover { 
                                background: #F9FAFB;
                            }
                            .competition-high { 
                                background: #FEE2E2; 
                                color: #B91C1C; 
                                padding: 2px 6px; 
                                border-radius: 4px; 
                                font-size: 10px;
                                font-weight: 600;
                            }
                            .competition-medium { 
                                background: #FEF3C7; 
                                color: #B45309; 
                                padding: 2px 6px; 
                                border-radius: 4px; 
                                font-size: 10px;
                                font-weight: 600;
                            }
                            .competition-low { 
                                background: #D1FAE5; 
                                color: #059669; 
                                padding: 2px 6px; 
                                border-radius: 4px; 
                                font-size: 10px;
                                font-weight: 600;
                            }
                            .competition-grid {
                                display: grid;
                                grid-template-columns: repeat(3, 1fr);
                                gap: 15px;
                                margin-bottom: 20px;
                            }
                            .competition-item {
                                text-align: center;
                                padding: 15px;
                                background: #F8FAFC;
                                border-radius: 6px;
                            }
                            .competition-count {
                                font-size: 20px;
                                font-weight: bold;
                                margin-bottom: 4px;
                            }
                            .competition-count.high { color: #DC2626; }
                            .competition-count.medium { color: #D97706; }
                            .competition-count.low { color: #059669; }
                            .footer {
                                margin-top: 40px;
                                padding-top: 20px;
                                border-top: 1px solid #E5E7EB;
                                text-align: center;
                                color: #6B7280;
                                font-size: 12px;
                            }
                            @media print {
                                body { margin: 0; }
                                .report-container { padding: 20px; }
                            }
                        </style>
                    </head>
                    <body>
                        ${reportHTML}
                    </body>
                </html>
            `);
            
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        function generatePDFContent() {
            if (!report) return '';

            return `
                <div class="report-container">
                    <div class="header">
                        <h1>Keyword Performance Report</h1>
                        <p>Generated on ${report.generatedDate}</p>
                    </div>

                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value">${report.totalKeywords}</div>
                            <div class="metric-label">Total Keywords</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${report.totalSearchVolume.toLocaleString()}</div>
                            <div class="metric-label">Total Monthly Searches</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${report.avgMonthlySearches.toLocaleString()}</div>
                            <div class="metric-label">Avg Monthly Searches</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${report.avgBid}</div>
                            <div class="metric-label">Avg Top of Page Bid</div>
                        </div>
                    </div>

                    <div class="section">
                        <h2 class="section-title">Competition Analysis</h2>
                        <div class="competition-grid">
                            ${Object.entries(report.competitionDistribution).map(([level, count]) => `
                                <div class="competition-item">
                                    <div class="competition-count ${level.toLowerCase()}">${count}</div>
                                    <div>${level} Competition</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="section">
                        <h2 class="section-title">Top 10 Keywords by Search Volume</h2>
                        <table class="keyword-table">
                            <thead>
                                <tr>
                                    <th>Keyword</th>
                                    <th style="text-align: right;">Monthly Searches</th>
                                    <th style="text-align: center;">Competition</th>
                                    <th style="text-align: right;">Top of Page Bid</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${report.topKeywords.map(keyword => `
                                    <tr>
                                        <td style="font-weight: 500;">${keyword.Keyword}</td>
                                        <td style="text-align: right;">${parseNumeric(keyword['Avg. monthly searches']).toLocaleString()}</td>
                                        <td style="text-align: center;">
                                            <span class="competition-${keyword.Competition?.toLowerCase() || 'low'}">${keyword.Competition || 'Low'}</span>
                                        </td>
                                        <td style="text-align: right;">${calculateAverageBid(keyword['Top of page bid (low range)'], keyword['Top of page bid (high range)']).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    ${report.growingKeywords.length > 0 ? `
                        <div class="section">
                            <h2 class="section-title">Growing Keywords (Positive YoY Growth)</h2>
                            <table class="keyword-table">
                                <thead>
                                    <tr>
                                        <th>Keyword</th>
                                        <th style="text-align: right;">Monthly Searches</th>
                                        <th style="text-align: center;">Competition</th>
                                        <th style="text-align: right;">YoY Change</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${report.growingKeywords.map(keyword => `
                                        <tr>
                                            <td style="font-weight: 500;">${keyword.Keyword}</td>
                                            <td style="text-align: right;">${parseNumeric(keyword['Avg. monthly searches']).toLocaleString()}</td>
                                            <td style="text-align: center;">
                                                <span class="competition-${keyword.Competition?.toLowerCase() || 'low'}">${keyword.Competition || 'Low'}</span>
                                            </td>
                                            <td style="text-align: right; color: #059669; font-weight: 600;">+${parsePercentage(keyword['YoY change'])}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}

                    ${report.opportunities.length > 0 ? `
                        <div class="section">
                            <h2 class="section-title">High Opportunity Keywords (Good Volume + Low/Medium Competition)</h2>
                            <table class="keyword-table">
                                <thead>
                                    <tr>
                                        <th>Keyword</th>
                                        <th style="text-align: right;">Monthly Searches</th>
                                        <th style="text-align: center;">Competition</th>
                                        <th style="text-align: right;">Top of Page Bid</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${report.opportunities.map(keyword => `
                                        <tr>
                                            <td style="font-weight: 500;">${keyword.Keyword}</td>
                                            <td style="text-align: right;">${parseNumeric(keyword['Avg. monthly searches']).toLocaleString()}</td>
                                            <td style="text-align: center;">
                                                <span class="competition-${keyword.Competition?.toLowerCase() || 'low'}">${keyword.Competition || 'Low'}</span>
                                            </td>
                                            <td style="text-align: right;">${calculateAverageBid(keyword['Top of page bid (low range)'], keyword['Top of page bid (high range)']).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}

                    <div class="footer">
                        <p>This report was generated automatically from your keyword data. All metrics are based on the most recent data available.</p>
                    </div>
                </div>
            `;
        }

        function newReport() {
            csvData = null;
            report = null;
            
            // Reset file input
            document.getElementById('fileInput').value = '';
            
            // Hide error and loading messages
            hideError();
            hideLoading();
            
            // Hide optional sections
            document.getElementById('growingSection').classList.add('hidden');
            document.getElementById('opportunitiesSection').classList.add('hidden');
            
            // Show upload section, hide report
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('reportSection').style.display = 'none';
        }
    </script>
</body>
</html>

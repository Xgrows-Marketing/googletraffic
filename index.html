<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyword Report Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #111827;
        }
        
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            max-width: 1024px;
            margin: 0 auto;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
        }
        
        .header-icon {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            fill: #2563eb;
        }
        
        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .container {
            max-width: 1024px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }
        
        .upload-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            text-align: center;
        }
        
        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            fill: #9ca3af;
        }
        
        .upload-title {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .upload-description {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }
        
        .upload-button {
            background: #2563eb;
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }
        
        .upload-button:hover {
            background: #1d4ed8;
        }
        
        .file-input {
            display: none;
        }
        
        .error-message {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            color: #dc2626;
            font-size: 0.875rem;
        }
        
        .loading-message {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            color: #1d4ed8;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #2563eb;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .report-section {
            display: none;
        }
        
        .report-header {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .report-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .report-date {
            color: #6b7280;
        }
        
        .report-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-green {
            background: #059669;
            color: white;
        }
        
        .btn-green:hover {
            background: #047857;
        }
        
        .btn-gray {
            background: #4b5563;
            color: white;
        }
        
        .btn-gray:hover {
            background: #374151;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .metric-label {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }
        
        .competition-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        .competition-item {
            text-align: center;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .competition-count {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .competition-high { color: #dc2626; }
        .competition-medium { color: #d97706; }
        .competition-low { color: #059669; }
        
        .table-container {
            overflow-x: auto;
        }
        
        .keyword-table {
            width: 100%;
            font-size: 0.875rem;
            border-collapse: collapse;
        }
        
        .keyword-table th {
            padding: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
            text-align: left;
        }
        
        .keyword-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .keyword-table tr:hover {
            background: #f9fafb;
        }
        
        .competition-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .competition-badge-high {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .competition-badge-medium {
            background: #fef3c7;
            color: #d97706;
        }
        
        .competition-badge-low {
            background: #d1fae5;
            color: #059669;
        }
        
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .text-green { color: #059669; font-weight: 500; }
        
        .hidden { display: none; }

        /* PDF-specific styles that will be hidden on screen */
        .pdf-content {
            display: none;
            background: white;
            font-family: Arial, sans-serif;
            line-height: 1.4;
            color: #333;
        }
        
        @media (max-width: 768px) {
            .report-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <svg class="header-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="10,9 9,9 8,9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h1 class="header-title">Keyword Report Generator</h1>
        </div>
    </div>

    <div class="container">
        <!-- Upload Section -->
        <div id="uploadSection" class="upload-section">
            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="17,8 12,3 7,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h2 class="upload-title">Upload Your CSV File</h2>
            <p class="upload-description">Generate a clean, professional keyword performance report</p>
            
            <label for="fileInput" class="upload-button">
                Choose File
            </label>
            <input type="file" id="fileInput" class="file-input" accept=".csv">
            
            <div id="errorMessage" class="error-message hidden"></div>
            <div id="loadingMessage" class="loading-message hidden">
                <div class="spinner"></div>
                Processing...
            </div>
        </div>

        <!-- Report Section -->
        <div id="reportSection" class="report-section">
            <!-- Report Header -->
            <div class="report-header">
                <div>
                    <h2 class="report-title">Keyword Performance Report</h2>
                    <p class="report-date" id="reportDate"></p>
                </div>
                <div class="report-actions">
                    <button class="btn btn-green" onclick="downloadPDF()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7,10 12,15 17,10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Download PDF
                    </button>
                    <button class="btn btn-gray" onclick="newReport()">New Report</button>
                </div>
            </div>

            <!-- Key Metrics -->
            <div id="metricsGrid" class="metrics-grid"></div>

            <!-- Competition Distribution -->
            <div class="section">
                <h3 class="section-title">Competition Distribution</h3>
                <div id="competitionGrid" class="competition-grid"></div>
            </div>

            <!-- Top Keywords -->
            <div class="section">
                <h3 class="section-title">Top 10 Keywords</h3>
                <div class="table-container">
                    <table class="keyword-table" id="topKeywordsTable">
                        <thead>
                            <tr>
                                <th>Keyword</th>
                                <th class="text-right">Monthly Searches</th>
                                <th class="text-center">Competition</th>
                                <th class="text-right">Top of Page Bid</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Growing Keywords -->
            <div class="section hidden" id="growingSection">
                <h3 class="section-title">Growing Keywords</h3>
                <div class="table-container">
                    <table class="keyword-table" id="growingKeywordsTable">
                        <thead>
                            <tr>
                                <th>Keyword</th>
                                <th class="text-right">Monthly Searches</th>
                                <th class="text-center">Competition</th>
                                <th class="text-right">YoY Growth</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Opportunities -->
            <div class="section hidden" id="opportunitiesSection">
                <h3 class="section-title">High Opportunity Keywords</h3>
                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">Keywords with good search volume and low/medium competition</p>
                <div class="table-container">
                    <table class="keyword-table" id="opportunitiesTable">
                        <thead>
                            <tr>
                                <th>Keyword</th>
                                <th class="text-right">Monthly Searches</th>
                                <th class="text-center">Competition</th>
                                <th class="text-right">Top of Page Bid</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- All Keywords -->
            <div class="section" id="allKeywordsSection">
                <h3 class="section-title">All Keywords</h3>
                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">Complete list of all uploaded keywords</p>
                <div class="table-container">
                    <table class="keyword-table" id="allKeywordsTable">
                        <thead>
                            <tr>
                                <th>Keyword</th>
                                <th class="text-right">Monthly Searches</th>
                                <th class="text-center">Competition</th>
                                <th class="text-right">Top of Page Bid</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let csvData = null;
        let report = null;

        // Utility functions
        function parseNumeric(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                // Handle special characters and formats
                if (value === '∞' || value === 'Infinity' || value === '') return 0;
                const cleaned = value.replace(/[,$%∞]/g, '');
                const num = parseFloat(cleaned);
                return isNaN(num) ? 0 : num;
            }
            return 0;
        }

        function parsePercentage(value) {
            if (typeof value === 'string') {
                if (value === '∞' || value === 'Infinity') return 0;
                if (value.includes('%')) {
                    const cleaned = value.replace('%', '');
                    return parseFloat(cleaned);
                }
            }
            return parseNumeric(value);
        }

        function calculateAverageBid(lowRange, highRange) {
            const low = parseNumeric(lowRange);
            const high = parseNumeric(highRange);
            if (low === 0 && high === 0) return 0;
            return (low + high) / 2;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showLoading() {
            document.getElementById('loadingMessage').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingMessage').classList.add('hidden');
        }

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type === 'text/csv') {
                processCSV(file);
            } else {
                showError('Please upload a valid CSV file.');
            }
        });

        function processCSV(file) {
            showLoading();
            hideError();

            Papa.parse(file, {
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    try {
                        // Find the header row (contains "Keyword")
                        let headerRowIndex = -1;
                        for (let i = 0; i < results.data.length; i++) {
                            if (results.data[i][0] === 'Keyword') {
                                headerRowIndex = i;
                                break;
                            }
                        }

                        if (headerRowIndex === -1) {
                            throw new Error('Could not find keyword data in CSV');
                        }

                        // Extract headers and data
                        const headers = results.data[headerRowIndex];
                        const dataRows = results.data.slice(headerRowIndex + 1);

                        // Convert to objects
                        const data = dataRows
                            .map(row => {
                                const obj = {};
                                headers.forEach((header, index) => {
                                    obj[header] = row[index];
                                });
                                return obj;
                            })
                            .filter(row => row.Keyword && row.Keyword.trim() !== '' && row.Keyword !== 'Keyword');

                        csvData = data;
                        generateReport(data);
                    } catch (err) {
                        showError('Error processing CSV file: ' + err.message);
                        console.error('CSV processing error:', err);
                    }
                    hideLoading();
                },
                error: function(error) {
                    showError('Failed to parse CSV file: ' + error.message);
                    hideLoading();
                }
            });
        }

        function generateReport(data) {
            console.log('Processing data:', data); // Debug log

            const totalKeywords = data.length;
            const totalSearchVolume = _.sumBy(data, row => parseNumeric(row['Avg. monthly searches']));
            const avgMonthlySearches = Math.round(totalSearchVolume / totalKeywords);

            const competitionDistribution = _.countBy(data, 'Competition');
            
            // Calculate average bid using the average of low and high range
            const avgBid = _.meanBy(data, row => calculateAverageBid(
                row['Top of page bid (low range)'], 
                row['Top of page bid (high range)']
            ));

            const topKeywords = _.orderBy(data, 
                row => parseNumeric(row['Avg. monthly searches']), 
                'desc'
            ).slice(0, 10);

            const growingKeywords = data.filter(row => {
                const yoyChange = parsePercentage(row['YoY change']);
                return yoyChange > 0;
            }).slice(0, 5);

            const opportunities = data.filter(row => {
                const volume = parseNumeric(row['Avg. monthly searches']);
                const competition = row['Competition'];
                return volume >= 50 && (competition === 'Low' || competition === 'Medium');
            }).slice(0, 5);

            // Sort all keywords by search volume for display
            const allKeywords = _.orderBy(data, 
                row => parseNumeric(row['Avg. monthly searches']), 
                'desc'
            );

            report = {
                totalKeywords,
                totalSearchVolume,
                avgMonthlySearches,
                competitionDistribution,
                avgBid: isNaN(avgBid) ? 0 : avgBid.toFixed(2),
                topKeywords,
                growingKeywords,
                opportunities,
                allKeywords,
                generatedDate: new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                })
            };

            console.log('Generated report:', report); // Debug log
            displayReport();
        }

        function displayReport() {
            // Show report section
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('reportSection').style.display = 'block';

            // Set report date
            document.getElementById('reportDate').textContent = `Generated on ${report.generatedDate}`;

            // Display metrics
            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${report.totalKeywords}</div>
                    <div class="metric-label">Total Keywords</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${report.totalSearchVolume.toLocaleString()}</div>
                    <div class="metric-label">Monthly Searches</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${report.avgMonthlySearches.toLocaleString()}</div>
                    <div class="metric-label">Avg per Keyword</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">$${report.avgBid}</div>
                    <div class="metric-label">Avg Top of Page Bid</div>
                </div>
            `;

            // Display competition distribution
            const competitionGrid = document.getElementById('competitionGrid');
            competitionGrid.innerHTML = Object.entries(report.competitionDistribution).map(([level, count]) => `
                <div class="competition-item">
                    <div class="competition-count competition-${level.toLowerCase()}">${count}</div>
                    <div>${level}</div>
                </div>
            `).join('');

            // Display top keywords
            const topKeywordsTable = document.getElementById('topKeywordsTable').querySelector('tbody');
            topKeywordsTable.innerHTML = report.topKeywords.map(keyword => `
                <tr>
                    <td style="font-weight: 500;">${keyword.Keyword}</td>
                    <td class="text-right">${parseNumeric(keyword['Avg. monthly searches']).toLocaleString()}</td>
                    <td class="text-center">
                        <span class="competition-badge competition-badge-${keyword.Competition?.toLowerCase() || 'low'}">
                            ${keyword.Competition || 'Low'}
                        </span>
                    </td>
                    <td class="text-right">$${calculateAverageBid(keyword['Top of page bid (low range)'], keyword['Top of page bid (high range)']).toFixed(2)}</td>
                </tr>
            `).join('');

            // Display growing keywords if available
            if (report.growingKeywords.length > 0) {
                document.getElementById('growingSection').classList.remove('hidden');
                const growingTable = document.getElementById('growingKeywordsTable').querySelector('tbody');
                growingTable.innerHTML = report.growingKeywords.map(keyword => `
                    <tr>
                        <td style="font-weight: 500;">${keyword.Keyword}</td>
                        <td class="text-right">${parseNumeric(keyword['Avg. monthly searches']).toLocaleString()}</td>
                        <td class="text-center">
                            <span class="competition-badge competition-badge-${keyword.Competition?.toLowerCase() || 'low'}">
                                ${keyword.Competition || 'Low'}
                            </span>
                        </td>
                        <td class="text-right text-green">+${parsePercentage(keyword['YoY change'])}%</td>
                    </tr>
                `).join('');
            }

            // Display all keywords
            const allKeywordsTable = document.getElementById('allKeywordsTable').querySelector('tbody');
            allKeywordsTable.innerHTML = report.allKeywords.map(keyword => `
                <tr>
                    <td style="font-weight: 500;">${keyword.Keyword}</td>
                    <td class="text-right">${parseNumeric(keyword['Avg. monthly searches']).toLocaleString()}</td>
                    <td class="text-center">
                        <span class="competition-badge competition-badge-${keyword.Competition?.toLowerCase() || 'low'}">
                            ${keyword.Competition || 'Low'}
                        </span>
                    </td>
                    <td class="text-right">$${calculateAverageBid(keyword['Top of page bid (low range)'], keyword['Top of page bid (high range)']).toFixed(2)}</td>
                </tr>
            `).join('');

            // Display opportunities if available
            if (report.opportunities.length > 0) {
                document.getElementById('opportunitiesSection').classList.remove('hidden');
                const opportunitiesTable = document.getElementById('opportunitiesTable').querySelector('tbody');
                opportunitiesTable.innerHTML = report.opportunities.map(keyword => `
                    <tr>
                        <td style="font-weight: 500;">${keyword.Keyword}</td>
                        <td class="text-right">${parseNumeric(keyword['Avg. monthly searches']).toLocaleString()}</td>
                        <td class="text-center">
                            <span class="competition-badge competition-badge-${keyword.Competition?.toLowerCase() || 'low'}">
                                ${keyword.Competition || 'Low'}
                            </span>
                        </td>
                        <td class="text-right">$${calculateAverageBid(keyword['Top of page bid (low range)'], keyword['Top of page bid (high range)']).toFixed(2)}</td>
                    </tr>
                `).join('');
            }
        }

        async function downloadPDF() {
            if (!report) {
                alert('No report data available');
                return;
            }

            try {
                // Show loading state
                const downloadBtn = document.querySelector('.btn-green');
                const originalText = downloadBtn.innerHTML;
                downloadBtn.innerHTML = '<div class="spinner" style="width:14px;height:14px;margin-right:8px;"></div>Generating PDF...';
                downloadBtn.disabled = true;

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // PDF settings
                const pageWidth = pdf.internal.pageSize.width;
                const pageHeight = pdf.internal.pageSize.height;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                let currentY = margin;

                // Helper function to check if we need a new page
                function checkPageBreak(neededHeight) {
                    if (currentY + neededHeight > pageHeight - margin) {
                        pdf.addPage();
                        currentY = margin;
                        return true;
                    }
                    return false;
                }

                // Title
                pdf.setFontSize(24);
                pdf.setFont(undefined, 'bold');
                pdf.text('Keyword Performance Report', pageWidth / 2, currentY, { align: 'center' });
                currentY += 15;

                pdf.setFontSize(12);
                pdf.setFont(undefined, 'normal');
                pdf.text(`Generated on ${report.generatedDate}`, pageWidth / 2, currentY, { align: 'center' });
                currentY += 20;

                // Key Metrics
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text('Key Metrics', margin, currentY);
                currentY += 10;

                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                
                const metrics = [
                    ['Total Keywords', report.totalKeywords.toString()],
                    ['Total Monthly Searches', report.totalSearchVolume.toLocaleString()],
                    ['Average per Keyword', report.avgMonthlySearches.toLocaleString()],
                    ['Average Top of Page Bid', `${report.avgBid}`]
                ];

                const metricsPerRow = 2;
                const metricBoxWidth = contentWidth / metricsPerRow;
                const metricBoxHeight = 25;

                for (let i = 0; i < metrics.length; i += metricsPerRow) {
                    checkPageBreak(metricBoxHeight + 5);
                    
                    for (let j = 0; j < metricsPerRow && i + j < metrics.length; j++) {
                        const x = margin + (j * metricBoxWidth);
                        const metric = metrics[i + j];
                        
                        // Draw metric box
                        pdf.setFillColor(248, 249, 250);
                        pdf.rect(x, currentY, metricBoxWidth - 2, metricBoxHeight, 'F');
                        pdf.setDrawColor(229, 231, 235);
                        pdf.rect(x, currentY, metricBoxWidth - 2, metricBoxHeight, 'S');
                        
                        // Add metric text
                        pdf.setFont(undefined, 'bold');
                        pdf.setFontSize(14);
                        pdf.text(metric[1], x + (metricBoxWidth - 2) / 2, currentY + 12, { align: 'center' });
                        
                        pdf.setFont(undefined, 'normal');
                        pdf.setFontSize(8);
                        pdf.text(metric[0], x + (metricBoxWidth - 2) / 2, currentY + 20, { align: 'center' });
                    }
                    currentY += metricBoxHeight + 5;
                }

                currentY += 10;

                // Competition Distribution
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text('Competition Distribution', margin, currentY);
                currentY += 10;

                const competitionEntries = Object.entries(report.competitionDistribution);
                const compBoxWidth = contentWidth / 3;
                const compBoxHeight = 20;

                checkPageBreak(compBoxHeight + 5);

                for (let i = 0; i < competitionEntries.length; i++) {
                    const [level, count] = competitionEntries[i];
                    const x = margin + (i * compBoxWidth);
                    
                    // Set color based on competition level
                    let fillColor = [248, 249, 250]; // default gray
                    if (level === 'High') fillColor = [254, 242, 242];
                    else if (level === 'Medium') fillColor = [254, 243, 199];
                    else if (level === 'Low') fillColor = [209, 250, 229];
                    
                    pdf.setFillColor(...fillColor);
                    pdf.rect(x, currentY, compBoxWidth - 2, compBoxHeight, 'F');
                    pdf.setDrawColor(229, 231, 235);
                    pdf.rect(x, currentY, compBoxWidth - 2, compBoxHeight, 'S');
                    
                    pdf.setFont(undefined, 'bold');
                    pdf.setFontSize(12);
                    pdf.text(count.toString(), x + (compBoxWidth - 2) / 2, currentY + 10, { align: 'center' });
                    
                    pdf.setFont(undefined, 'normal');
                    pdf.setFontSize(8);
                    pdf.text(`${level} Competition`, x + (compBoxWidth - 2) / 2, currentY + 16, { align: 'center' });
                }

                currentY += compBoxHeight + 15;

                // Helper function to create tables
                function createTable(title, data, headers) {
                    checkPageBreak(60); // Ensure space for title and at least a few rows
                    
                    pdf.setFontSize(16);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(title, margin, currentY);
                    currentY += 10;

                    if (data.length === 0) {
                        pdf.setFontSize(10);
                        pdf.setFont(undefined, 'normal');
                        pdf.text('No data available', margin, currentY);
                        currentY += 15;
                        return;
                    }

                    const colWidths = [
                        contentWidth * 0.4,  // Keyword
                        contentWidth * 0.2,  // Monthly Searches
                        contentWidth * 0.2,  // Competition
                        contentWidth * 0.2   // Bid/Growth
                    ];

                    // Table headers
                    checkPageBreak(20);
                    pdf.setFillColor(248, 249, 250);
                    pdf.rect(margin, currentY, contentWidth, 8, 'F');
                    pdf.setDrawColor(229, 231, 235);
                    pdf.rect(margin, currentY, contentWidth, 8, 'S');

                    pdf.setFont(undefined, 'bold');
                    pdf.setFontSize(8);
                    
                    let x = margin;
                    headers.forEach((header, i) => {
                        const align = i === 0 ? 'left' : (i === 2 ? 'center' : 'right');
                        const textX = align === 'left' ? x + 2 : 
                                     align === 'center' ? x + colWidths[i] / 2 : 
                                     x + colWidths[i] - 2;
                        pdf.text(header, textX, currentY + 5, { align });
                        x += colWidths[i];
                    });

                    currentY += 8;

                    // Table rows
                    pdf.setFont(undefined, 'normal');
                    data.forEach((row, index) => {
                        if (index >= 10) return; // Limit rows to prevent overcrowding
                        
                        checkPageBreak(10);
                        
                        const rowY = currentY;
                        
                        // Alternating row background
                        if (index % 2 === 0) {
                            pdf.setFillColor(249, 250, 251);
                            pdf.rect(margin, rowY, contentWidth, 8, 'F');
                        }
                        
                        pdf.setDrawColor(243, 244, 246);
                        pdf.rect(margin, rowY, contentWidth, 8, 'S');

                        let x = margin;
                        
                        // Keyword
                        pdf.setFont(undefined, 'bold');
                        pdf.setFontSize(7);
                        const keywordText = row[0].length > 30 ? row[0].substring(0, 30) + '...' : row[0];
                        pdf.text(keywordText, x + 2, rowY + 5);
                        x += colWidths[0];
                        
                        // Monthly Searches
                        pdf.setFont(undefined, 'normal');
                        pdf.text(row[1], x + colWidths[1] - 2, rowY + 5, { align: 'right' });
                        x += colWidths[1];
                        
                        // Competition
                        pdf.text(row[2], x + colWidths[2] / 2, rowY + 5, { align: 'center' });
                        x += colWidths[2];
                        
                        // Bid/Growth
                        pdf.text(row[3], x + colWidths[3] - 2, rowY + 5, { align: 'right' });
                        
                        currentY += 8;
                    });
                    
                    currentY += 10;
                }

                // Top Keywords Table
                const topKeywordsData = report.topKeywords.map(keyword => [
                    keyword.Keyword,
                    parseNumeric(keyword['Avg. monthly searches']).toLocaleString(),
                    keyword.Competition || 'Low',
                    `${calculateAverageBid(keyword['Top of page bid (low range)'], keyword['Top of page bid (high range)']).toFixed(2)}`
                ]);

                createTable('Top 10 Keywords by Search Volume', topKeywordsData, 
                    ['Keyword', 'Monthly Searches', 'Competition', 'Top Bid']);

                // Growing Keywords Table (if available)
                if (report.growingKeywords.length > 0) {
                    const growingKeywordsData = report.growingKeywords.map(keyword => [
                        keyword.Keyword,
                        parseNumeric(keyword['Avg. monthly searches']).toLocaleString(),
                        keyword.Competition || 'Low',
                        `+${parsePercentage(keyword['YoY change'])}%`
                    ]);

                    createTable('Growing Keywords (Positive YoY Growth)', growingKeywordsData,
                        ['Keyword', 'Monthly Searches', 'Competition', 'YoY Growth']);
                }

                // Opportunities Table (if available)
                if (report.opportunities.length > 0) {
                    const opportunitiesData = report.opportunities.map(keyword => [
                        keyword.Keyword,
                        parseNumeric(keyword['Avg. monthly searches']).toLocaleString(),
                        keyword.Competition || 'Low',
                        `${calculateAverageBid(keyword['Top of page bid (low range)'], keyword['Top of page bid (high range)']).toFixed(2)}`
                    ]);

                    createTable('High Opportunity Keywords (Good Volume + Low/Medium Competition)', 
                        opportunitiesData.slice(0, 10), 
                        ['Keyword', 'Monthly Searches', 'Competition', 'Top Bid']);
                }

                // Footer
                checkPageBreak(20);
                currentY = pageHeight - 20;
                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                pdf.setTextColor(100, 100, 100);
                pdf.text('Keyword Performance Analysis Report', pageWidth / 2, currentY, { align: 'center' });
                pdf.text(`Generated on ${new Date().toLocaleDateString()} • Page 1 of ${pdf.internal.getNumberOfPages()}`, 
                    pageWidth / 2, currentY + 5, { align: 'center' });

                // Save the PDF
                pdf.save(`Keyword_Performance_Report_${new Date().toISOString().split('T')[0]}.pdf`);

                // Reset button
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;

            } catch (error) {
                console.error('PDF generation error:', error);
                alert('Error generating PDF. Please try again.');
                
                // Reset button on error
                const downloadBtn = document.querySelector('.btn-green');
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
            }
        }

        function newReport() {
            csvData = null;
            report = null;
            
            // Reset file input
            document.getElementById('fileInput').value = '';
            
            // Hide error and loading messages
            hideError();
            hideLoading();
            
            // Hide optional sections
            document.getElementById('growingSection').classList.add('hidden');
            document.getElementById('opportunitiesSection').classList.add('hidden');
            
            // Show upload section, hide report
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('reportSection').style.display = 'none';
        }
    </script>
</body>
</html>
